## Перенос учебной БД AdventureWorks c SQL Server на PostgreSQL

1. В данной работе решается задача переноса учебной базы данных AdventureWorks c SQL Server на PostgreSQL.

2. Исходные данные следующие. База данных AdventureWorks загружена из
https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorks-oltp-install-script.zip 
и восстановлена на Microsoft SQL Server 2019. Сервер Postgresql из репозитория Debian 12 «Bookworm».

3. Требовалось выбрать инструмент для автоматического переноса, которым можно было бы воспользоваться по требованию по меньшей мере дважды. Первый - подготовить первую тестовую копию БД с целью портирования клиентского приложения или сервера приложений. Второй - окончательный перенос, после завершения тестирования портированного клиента и принятия решения о фактическом переходе на postgres. Но вероятнее всего такие переносы потребуется выполнить множество раз.
Были рассмотрены и частично протестированы средства, перечисленные на странице 
https://wiki.postgresql.org/wiki/Converting_from_other_Databases_to_PostgreSQL
Из перечисленного списка бесплатное ПО практически ничего не может. Можно рассмотреть вопрос об использовании платного ПО, но при этом придется положиться на разработчиков этих продуктов и их видение того, как нужно правильно переносить данные. Это видение может не совпадать с мнением заказчика. Кроме того, есть риск столкнуться с возможным истечением срока действия лицензии, пока идет адаптация программного обеспечения, или другими проблемами, которые невозможно заранее предусмотреть. Некоторые из этих продуктов стоят огромных денег. Кроме того, платное ПО все равно не сделает за нас всю работу. 

В итоге я остановился на не очень быстром, но значительно более предсказуемом подходе, предложенным Yogesh Mehla, который написал серию скриптов для портирования данных. Репозиторий его проекта 
https://github.com/yogimehla/SQLtoPostgresMigrationScript.
Репозиторий представляет собой несколько скриптов sql, с помощью которых можно передать схему базы данных и сами данные из базы MS SQL в postgres. Сам процесс переноса можно увидеть на его видео в ютубе https://www.youtube.com/watch?v=YKJub0zVztE.

4. К сожалению исходный вариант скриптов перенести AdventureWorks не может, в них не устранены (или специально оставлены) серьезные недоработки. Скрипты были переработаны. Все недостатки, что удалось найти, исправлены. Кроме того, переработанный вариант адаптирован непосредственно для AdventureWorks. 
Скрипты находятся в каталоге SQLtoPostgresMigrationScript-master.

5. В ходе борьбы с varbinary я разработал приложение с необычным названием ShowPictures.
![Иллюстрация к проекту](https://github.com/mike-ussoff/HW10/blob/main/ShowPictures.png) 
Идея была в том, чтобы заглянуть в поля с бинарными данными и проанализировать их содержимое. Postgres не хотел понимать формат бинарных данных, которые предоставлял ему скрипт. В результате в базе вместо реальных данных сохранялся мусор. Чтобы увидеть и проанализировать содержимое, нужно ввести запрос в поле (верхнем для MS SQL, нижнем для PostgreSQL), который вернет какое-то varbinary, image, geography и т.д. Если перенос произведен корректно, одинаковые запросы вернут одинаковые данные. Если это изображение, его можно сразу увидеть. Исходники находятся в каталоге ShowPictures. Собирается в VS 2022.

6. Основной проблемой оказался перенос типа hierarchyid. Он появился в MS SQL 2008 для реализации древовидной иерархии. В PostgreSQL прямого эквивалентного типа данных нет. Вместе с тем, для postgres есть расширение ltree, которое реализует нечто подобное. Проблема заключается в том, что в таблице Production.Document поле DocumentNode hierarchyid является первичным ключом. Использовать ltree в качестве первичного ключа вероятно возможно. Однако правильное использование этого типа предполагает применять его совместно с первичным ключом. Т.е. сам он первичным ключом быть не должен. В связи с чем в таблицу было добавлено дополнительное поле DocumentId SERIAL, которое и стало первичным ключом. За добавление дополнительного поля пришлось заплатить тем, что потребовалось поправить все последние скрипты, начиная с 6-го, чтобы они учитывали эту изменившуюся возможность. В целом, если hierarchyid в переносимой базе нет или если он не используется в качестве первичного ключа, перенос становится довольно простым делом.

7. После переноса базы данных отдельно требуется перенести всю кодовую базу: представления, функции, процедуры, триггеры. Я переписал пару функций и представлений. Но в целом задачи переписать весь код я себе не ставил. 

8. Тестирование. 
С помощью Step 5- Verify data after export.sql проверен состав и объем перенесенных данных. Создание первичных, вторичных, внешних ключей и перенесенные представления опосредовано выполняют некоторую проверку корректности перенесенных данных. Кроме того, с помощью программы ShowPictures проведена проверка содержимого бинарных полей.
Нагрузочное тестирование перенесенной базы не проводилось: помимо того, что в учебной базе слишком мало данных, также отсутствует приложение, реализующее некоторый API и работающее с этими данными.
